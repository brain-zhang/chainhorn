## 概览

该协议假设有一个底层的经过身份验证和有序的传输机制，该机制负责构造各个消息。
[BOLT＃8](08-transport.md) 指定了Lightning中使用的规范传输层，但满足上述标准的任何传输都可以替换它。

默认TCP端口为9735。这相当于十六进制0x2607：LIGHTNING的Unicode代码。

除非另有说明，否则所有数据字段均为无符号大端排序。

## 目录

* [连接处理和多路复用](#连接处理和多路复用)
* [闪电消息格式](#闪电消息格式)
* [设置消息](#设置消息)
    * [初始化消息](#初始化消息)
    * [错误消息](#错误消息)
* [控制消息](#控制消息)
    * [`ping/pong` 消息](#ping pong 消息)
* [致谢](#致谢)
* [参考](#参考)
* [作者](#作者)

## 连接处理和多路复用

每个节点只能建立一个连接（包含一个通道ID），通过此单个连接进行多路复用。

## 闪电消息格式

解密后，所有Lightning消息都具有以下形式：

1. `type` ：一个2字节的大端排序字段，指示消息的类型
2. `payload`：一个可变长度的有效负载，包含消息的其余部分，并且符合与`type`匹配的格式

`type`字段指示如何解释`payload`字段。
每种类型的格式由此代码库中的规范定义。
类型遵循_it's ok to be odd_规则，因此节点可能发送_奇数_的类型，而不确定接收者是否理解它。

发送节点：
  - 未经事先协商，不能发送此处未列出type的消息。
    
接收节点：
  - 当收到一个奇数，未知的类型时:
    - 必须忽略收到的消息。
  - 当收到一个偶数的，未知类型的消息时：
    - 必须将通道标记为失败。

消息按逻辑分组为四组，按设置的最高有效位排序：
    
  - 设置和控制(type值：0-31)：与连接设置，控制，支持的特性和错误报告相关的消息（如下所述）
  - 交易通道（type值: 32-127）：用于设置和拆除微支付频道的消息（在[BOLT #2](02-peer-protocol.md)中描述)
  - 承诺交易相关（type值: 128-255）：与更新当前承诺交易相关的消息，包括添加，撤销和结算HTLC以及更新费用和交换签名（在[BOLT #2](02-peer-protocol.md)中描述)
  - 路由（type值: 256-511）：包含节点和通道公告的消息，以及任何活动路由探索（在[BOLT #7](07-routing-gossip.md)中 描述)

传输层消息的大小表示用2字节的unsigned int;因此，消息长度最大为65535字节。

节点:
  - 消息中超出该类型预期长度的数据，必须忽略
  - 在收到内容长度不足的已知消息时：
    - 必须将通道标记为失败
  - 在本规范中协商一个选项：
    - 必须包括用该选项注释的所有字段。

### 合理性

默认情况下，`SHA2`和比特币公钥都被编码为大端排序，因此对其他字段使用不同的字节序是不合理的。

加密包装将长度限制为65535字节，并且协议中的消息无论如何都不会超过该长度。

_it's ok to be odd_ 规则允许未来的可选扩展，而无需再协商或在客户机中编写特殊代码。“ignore additional data”规则同样允许将来扩展。

消息采用8字节对齐可能更容易实现（这是适用任何类型的最大自然对齐要求）;但是，在type字段之后添加6字节填充被认为是浪费：可以通过将消息解密为具有6字节预填充的缓冲区来实现对齐。

## 设置消息

### `init` 消息

身份验证完成后，第一条消息将显示此节点支持或要求的特性，即使这是重新连接也要再确认。

[BOLT #9](09-features.md)  指定全局和本地功能的列表。每个功能通常用2 bits表示`globalfeatures`(全局功能)或者`localfeatures`(本地功能)。最低有效位编号为0，即 _偶数_，下一个最重要的位编号为1，这是奇数。

`globalfeatures`和`localfeatures`单位长度为字节，如果不满1字节， 必须以0填充。

1. type：16（init)
2. data：
  * [`2`： `gflen` ]
  * [`gflen`：`globalfeatures` ]
  * [`2`： `lflen` ]
  * [`lflen`：`localfeatures` ]

2字节的字段`gflen`、`lflen`表示之后字段的长度(字节)

#### 要求

发送节点：
  - 必须发送 `init` 作为任何连接的第一个Lightning消息。
  - 必须按照 [BOLT #9](09-features.md)中的 定义设置代表特性的比特位 。
  - 必须将任何未定义的特性比特位设置为0。
  - 应该使用表示特性字段所需的最小长度。

接收节点：
  - 在发送任何其他消息之前 必须等待接收 `init` 。
  - 必须响应 [BOLT #9](09-features.md)中 指定的已知特性比特位 。
  - 在接收 到非零的 未知 _奇数_ 特性比特位时：
    - 必须忽略此比特位。
  - 在接收 到非零的 未知 _偶数_ 特性比特位时：
    - 必须标记连接为失败。

#### 原理

此语义允许将来不兼容的更改和向后兼容的更改。比特位通常是成对分配的，这样可选的特性就可能在将来成为必需的。

当收到的特性消息不兼容时，节点等待接收其他特性消息，以简化错误诊断。

特性掩码分为局部特性(只影响这两个节点之间的协议)和全局特性(可能影响HTLCs，因此也向其他节点发布)。

### `错误` 消息

为了简化诊断，通常告诉对端某件事出错了是很有用的。

1. type：17（ `error` ）
2. data：
  * [`32` ： `channel_id` ]
  * [`2`： `len` ]
  * [`len` ： `data` ]

2字节的`len`字段表示紧跟其后的字段中的字节数。

#### 要求

通道由`channel_id`引用，除非`channel_id`为0(即所有字节为0)，在这种情况下，它代表所有通道。

funding节点：
  - 对于`funding_created`消息之前(包括)发送的所有错误消息:
    - 必须使用`temporary_channel_id`代替`channel_id`。

fundee节点：
  - 对于之前（并且不包括） `funding_signed` 消息 发送的所有错误 消息：
    - 必须使用 `temporary_channel_id` 代替 `channel_id` 。

发送节点：
  - 发送 `error`时 ：
    - 必须使发送错误消息的通道标记为失败。
  - 如果协议解析出错或发生内部错误，必须将通道标记为不可用状态，阻止后面的通信，并发送`error`。
  - 如果收到了一个未知`channel_id`的type值为`32`-`255`的消息，必须用这个`channel_id`发送`error`消息。
  - 可以发送一个空`data`字段。
  - 当失败是由无效的签名检查引起的：
    - 在响应`funding_created`、`funding_signed`、`closing_signed`或`commitment_signed`消息时，应该包含原始的、十六进制编码的交易。
  - 当 `channel_id` 为0时：
    - 必须使接收节点的所有通道都标记为失败。
    - 必须关闭连接。
  - 必须将 `len`字段 设置为`data`字段长度。

接收节点：
  - 收到 `error`消息后 ：
    - 如果此通道是发送节点，必须将关联此消息的通道标为失败
  - 如果消息没有关联现有通道：
    - 必须忽略该消息。
  - 必须将从len到数据包的其余部分截断（如果它更大）。
  - 如果数据不完全由可打印ASCII字符组成(参考:可打印字符集指字节值32到126):
    - 不应逐字打印数据。

#### 合理性

存在不可恢复的错误，需要终止对话;如果只是简单地删除连接，则对端可以重试连接。描述用于诊断的协议违反情况也很有用，因为这表明一个通信端有bug。

明智的做法是不区分生产设置中的错误，以免它泄漏信息——因此，数据字段是可选的。

## 控制消息

### `ping`和`pong`消息

为了允许存在长生命周期的TCP连接，有时可能需要两端在应用程序级别上保持TCP一直处于活动状态。此类消息还允许混淆流量模式。

1. type：18（ `ping` ）
2. data：
    * [ `2` ： `num_pong_bytes` ]
    * [ `2` ： `byteslen` ]
    * [ `byteslen` ： `ignored` ]

每当收到一条`ping`消息，就要发送一条`pong`消息。`pong`消息作为一个应答，除了显式地通知对端接收方仍然处于活动状态，还可以保持连接的活动状态。当收到一条`ping`消息后，发送方就会将之后要发送的数据字段长度放在`pong`消息中回应对端。

1. type: 19(`pong`)
2. data：
    * [ `2` ： `byteslen` ]
    * [ `byteslen` ： `ignored` ]

#### 要求

发送 `ping` 消息的 节点 ：
  - 应该将`ignored`设置为0秒
  - 绝不能将敏感数据，如密钥或部分初始化内存设置为`ignored`。
  - 如果它没有收到相应的pong回应:
    - 可以终止网络连接，
      - 在这种情况下，不得将通道标记为失效。
  - 每30s最多只能发送一条消息

发送 `pong` 消息的 节点 ：

  - 应该将`ignored`设置为0秒
  - 绝不能将敏感数据，如密钥或部分初始化内存设置为`ignored`。

接收 `ping` 消息的 节点 ：
  - 如果通道道 每30秒 收到一次超过一次的 `ping` ， 应该标记通道为失败 。
  - 如果 `num_pong_bytes` 小于65532：
    - 必须通过发送 `pong` 消息来 响应 ，其中 `byteslen` 等于 `num_pong_bytes` 。
  - 否则（`num_pong_bytes` 不 小于65532）：
    - 必须忽略 ping 。

接收 `pong` 消息的 节点 ：
  - 如果 `byteslen` 与 它发送的 任何 `ping` 的 `num_pong_bytes` 值 不对应 ：
    - 通道连接可能会失败。

### 合理性

最大的消息是65535字节;因此，最大可解析的`byteslen`是65531 — 为了解释type字段(`pong`)和`byteslen`本身。这允许对`num_pong_bytes`进行方便的截断，表示不应发送回复。

网络内节点之间的连接可能是长期的，因为支付通道的生命周期是不确定的。但是，很可能在连接的生命周期的大部分时间内不会交换新数据。此外，在多个平台上，Lightning客户端可能会在没有事先警告的情况下进入睡眠状态。因此，将使用一个不同的ping消息，以探测另一端连接的活动情况，并保持已建立的连接处于活动状态。

此外，发送方请求接收方发送具有特定字节数的响应的能力使网络上的节点能够创建 _合成_ 流量。这种流量可以用来部分抵御数据包和定时分析，因为节点可以伪造典型交换机的流量模式，而不需要对各自的通道应用任何真正的更新。

当与[BOLT #4](04-onion-routing.md)定义的洋葱路由协议结合使用时，谨慎的统计驱动的合成流量可以进一步增强网络中参与者的隐私。

建议对`ping`洪水采取有限的预防措施，但是由于网络延迟，会给出一定的自由度。请注意，还有其他传入流量泛滥的方法（例如发送 _odd_ 奇怪的 未知消息类型，或最大填充每条消息）。

最后，使用周期性`ping`消息可以促进频繁的键旋转，正如在 [BOLT #8](08-transport.md) 中指定的那样。

## 致谢

[TODO: (roasbeef); fin ]

## 参考

http://www.unicode.org/charts/PDF/U2600.pdf

## 作者

[ FIXME: Insert Author List ]

![Creative Commons License](https://i.creativecommons.org/l/by/4.0/88x31.png "License CC-BY")
<br>
This work is licensed under a [Creative Commons Attribution 4.0 International License](http://creativecommons.org/licenses/by/4.0/).
